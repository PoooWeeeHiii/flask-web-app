name: Deploy Flask App to Touge Server

on:
  push:
    branches: [ main ]   # æ¨é€åˆ° main è‡ªåŠ¨è§¦å‘
  workflow_dispatch:     # ä¹Ÿå…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            **/requirements.txt

      - name: Install dependencies & run tests
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest==8.4.1
          pytest -v

      # ====== ä»è¿™æ­¥å¼€å§‹æ˜¯éƒ¨ç½² =========
      - name: Deploy to Touge Server via SSH (Port 51959)
        env:
          IP: ${{ secrets.TOUGE_SERVER_IP }}   # ä¾‹å¦‚ 47.96.157.89
          PORT: 51959                          # ä½ çš„ SSH ç«¯å£å·ï¼ˆæˆªå›¾ç¡®è®¤ï¼‰
        run: |
          set -euxo pipefail

          echo "ğŸ—ï¸ é…ç½® SSH ç§é’¥"
          mkdir -p ~/.ssh
          printf "%s\n" "${{ secrets.TOUGE_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          echo "ğŸ” å…ˆæ£€æµ‹ç«¯å£è¿é€šæ€§ï¼ˆ5ç§’è¶…æ—¶ï¼‰"
          timeout 5 bash -lc "cat < /dev/null > /dev/tcp/$IP/$PORT" \
            || { echo "âŒ $IP:$PORT ä¸å¯è¾¾ï¼Œè¯·æ£€æŸ¥å…¬ç½‘IP/ç«¯å£/å®ä¾‹çŠ¶æ€/å®‰å…¨ç»„"; exit 2; }

          echo "ğŸ§¾ æ”¶é›†ä¸»æœºæŒ‡çº¹ï¼ˆå¤±è´¥ä¸ç»ˆæ­¢ï¼‰"
          ssh-keyscan -p $PORT -H $IP >> ~/.ssh/known_hosts || true

          echo "ğŸšª å°è¯•æ¡æ‰‹ï¼ˆå¼€å¯è¯¦ç»†æ—¥å¿—ï¼‰"
          ssh -vvv -o StrictHostKeyChecking=no -p $PORT root@$IP 'echo "âœ… å·²ç™»å½•ï¼š$(whoami)@$(hostname)"; uname -a'

          echo "ğŸšš æ‰§è¡Œè¿œç¨‹éƒ¨ç½²è„šæœ¬"
          ssh -p $PORT -o StrictHostKeyChecking=no root@$IP <<'EOF'
            set -e
            export DEBIAN_FRONTEND=noninteractive

            # ç›®æ ‡ç›®å½•
            APP_DIR=/root/flask-web-app
            REPO_URL="https://github.com/${GITHUB_REPOSITORY}.git"

            echo "ğŸ“ ç¡®ä¿ç›®å½•å­˜åœ¨ï¼š$APP_DIR"
            mkdir -p "$APP_DIR"

            if [ ! -d "$APP_DIR/.git" ]; then
              echo "ğŸ§© é¦–æ¬¡éƒ¨ç½²ï¼šå…‹éš†ä»“åº“"
              rm -rf "$APP_DIR" && mkdir -p "$APP_DIR"
              git clone "$REPO_URL" "$APP_DIR"
            else
              echo "ğŸ”„ æ‹‰å–æœ€æ–°ä»£ç "
              cd "$APP_DIR"
              # å¦‚æœ remote æ²¡é…ç½®æˆ–å˜æ›´ï¼Œå¼ºåˆ¶è®¾ç½®ä¸º https
              git remote set-url origin "$REPO_URL" || true
              git fetch origin
              git reset --hard origin/main
            fi

            cd "$APP_DIR"
            echo "ğŸ“š å®‰è£…ä¾èµ–"
            apt-get update -y
            apt-get install -y python3-pip supervisor || true
            pip3 install --upgrade pip
            pip3 install -r requirements.txt

            echo "ğŸ§© å†™å…¥ supervisor é…ç½®ï¼ˆè‹¥ä¸å­˜åœ¨åˆ™åˆ›å»ºï¼‰"
            CONF=/etc/supervisor/conf.d/flask-web-app.conf
            if [ ! -f "$CONF" ]; then
              cat > "$CONF" <<CONFEOF
[program:flask-web-app]
command=/usr/bin/python3 /root/flask-web-app/src/app.py
directory=/root/flask-web-app
user=root
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/root/flask-web-app/app.log
CONFEOF
            fi

            echo "ğŸ” é‡æ–°åŠ è½½å¹¶é‡å¯æœåŠ¡"
            supervisorctl reread || true
            supervisorctl update || true
            supervisorctl restart flask-web-app || supervisorctl start flask-web-app

            echo "âœ… å½“å‰çŠ¶æ€ï¼š"
            supervisorctl status flask-web-app || true

            echo "ğŸ“– æœ€è¿‘æ—¥å¿—ï¼ˆæœ«å°¾20è¡Œï¼‰ï¼š"
            tail -n 20 /root/flask-web-app/app.log || true
          EOF
