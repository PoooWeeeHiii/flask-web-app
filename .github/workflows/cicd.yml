name: Deploy Flask App to Touge Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: requirements.txt

      - name: Install dependencies and run tests
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest==8.4.1
          echo "âœ… Dependencies installed, running tests..."
          pytest tests/ -v
        continue-on-error: false

      - name: Deploy to Touge Server via SSH (Port 50241)
        run: |
          echo "âš™ï¸ å¼€å§‹é…ç½® SSH ç¯å¢ƒ..."
          mkdir -p ~/.ssh
          printf "%s\n" "${{ secrets.TOUGE_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p 50241 -H 47.96.157.89 >> ~/.ssh/known_hosts
          echo "âœ… SSHé…ç½®å®Œæˆï¼Œå¼€å§‹éƒ¨ç½²..."

          ssh -v -p 50241 -o StrictHostKeyChecking=no -o HostKeyAlgorithms=+ssh-rsa -o PubkeyAcceptedAlgorithms=+ssh-rsa root@47.96.157.89 << 'EOF'
            set -e
            echo "ğŸ–¥ï¸ æˆåŠŸè¿æ¥åˆ°æœåŠ¡å™¨ï¼š$(hostname)"
            cd /root/flask-web-app || { echo "âŒ é¡¹ç›®ç›®å½•ä¸å­˜åœ¨"; exit 1; }

            echo "ğŸ“¦ æ‹‰å–æœ€æ–°ä»£ç ..."
            git pull origin main || { echo "âŒ Gitæ‹‰å–å¤±è´¥"; exit 1; }

            echo "ğŸ“š å®‰è£…ä¾èµ–..."
            pip3 install --upgrade pip
            pip3 install -r requirements.txt || { echo "âŒ ä¾èµ–å®‰è£…å¤±è´¥"; exit 1; }

            echo "ğŸ” é‡å¯ Flask åº”ç”¨..."
            supervisorctl reread
            supervisorctl update
            supervisorctl restart flask-web-app || { echo "âŒ åº”ç”¨é‡å¯å¤±è´¥"; exit 1; }

            echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
            supervisorctl status flask-web-app
          EOF
